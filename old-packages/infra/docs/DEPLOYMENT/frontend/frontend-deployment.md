# Bellyfed Frontend Deployment Guide

This document provides comprehensive instructions for deploying the Bellyfed frontend application using AWS CodePipeline.

## Overview

The Bellyfed frontend is deployed as a static Next.js application to AWS using CodePipeline for CI/CD automation. This guide covers all aspects of the deployment process, from architecture to troubleshooting.

## Architecture

The deployment architecture consists of the following components:

1. **Next.js Static Export**: The application is built using Next.js with `output: 'export'` configuration, generating static HTML/CSS/JS files in the `out` directory.
2. **AWS CodePipeline**: Orchestrates the CI/CD pipeline for the frontend application.
3. **AWS CodeBuild**: Builds and tests the frontend application.
4. **Amazon S3**: Stores the static files generated by Next.js.
5. **Amazon CloudFront**: Serves the content from the S3 bucket with proper caching and edge distribution.
6. **Amazon Route53**: Manages DNS records for custom domains.
7. **AWS Certificate Manager**: Provides SSL/TLS certificates for custom domains.

## Pipeline Simplification (April 2025)

As of April 2025, the frontend CI/CD pipeline has been simplified:

1. **Removed Git Operations**: Versioning, tagging, and changelog generation have been removed from the pipeline and are now handled manually as part of the standard Git workflow.
2. **Focus on Core Responsibilities**: The pipeline now focuses solely on building Docker images and deploying them to ECS.
3. **Improved Docker Build Process**: The Docker build process has been enhanced to avoid BuildKit permission issues and improve reliability.
4. **Enhanced ECR Authentication**: The pipeline now includes proper ECR authentication to ensure Docker images can be pushed successfully.

This simplification follows the principle of separation of concerns:

- Git handles versioning and history
- CI/CD handles building and deploying

## Environment Mapping

The frontend repository branches are mapped to environments as follows:

- `develop` branch → `dev` environment (app-dev.bellyfed.com)
- `staging` branch → `staging` environment (app-staging.bellyfed.com)
- `main` branch → `prod` environment (app.bellyfed.com)

This mapping is defined in the `CONFIG.frontend.branchMapping` object in the `config.ts` file.

### Feature Environments

The frontend CICD stack automatically creates pipelines for new branches. When you create a new branch and deploy it as a new environment, the system will:

1. First check if there's a mapping in `CONFIG.frontend.branchMapping` for the environment
2. If a mapping exists, it will use the mapped branch name
3. If no mapping exists, it will use the branch name directly

This means you can deploy feature branches without manually updating the configuration:

```bash
npx cdk deploy --context environment=feature1 --context branch=feature/your-branch-name --all
```

This will automatically:

1. Create CloudFront resources for the new environment
2. Create a frontend CICD pipeline that watches your feature branch
3. Deploy changes from your feature branch to the new environment

#### Custom Branch Mapping (Optional)

If you prefer to explicitly define branch mappings, you can update the `CONFIG.frontend.branchMapping` in `config.ts`:

```typescript
frontend: {
    owner: 'ming0627',
    repo: 'bellyfed',
    branchMapping: {
        dev: 'develop',
        staging: 'staging',
        prod: 'main',
        feature1: 'feature/your-branch-name' // Custom mapping
    }
}
```

## Deployment Operations

There are two main operations related to the frontend deployment:

1. **Deploying the Frontend CICD Stack** - This updates the CodePipeline configuration defined in `lib/frontend-cicd-stack.ts`
2. **Triggering the Frontend Pipeline** - This starts a new execution of the existing pipeline

### Option 1: Deploying the Frontend CICD Stack

If you need to update the CodePipeline configuration (e.g., change the source repository, branch, build steps, etc.), you need to deploy the Frontend CICD Stack:

```bash
# Using the script directly
./scripts/deploy-frontend-cicd.sh dev  # For dev environment

# Or using npm scripts
npm run deploy:frontend-cicd:dev   # For dev environment
```

This script uses CDK to deploy the `BellyfedFrontendCicdStack` defined in `lib/frontend-cicd-stack.ts`. It will update the CodePipeline configuration and then start a new pipeline execution.

### Option 2: Triggering the Pipeline (Recommended)

If you just need to trigger a new execution of the existing pipeline (without changing its configuration), you can use the update script:

```bash
# Using the script directly
./scripts/update-frontend-pipeline.sh dev  # For dev environment
./scripts/update-frontend-pipeline.sh qa   # For qa environment
./scripts/update-frontend-pipeline.sh prod # For prod environment

# Or using npm scripts
npm run update:frontend:dev   # For dev environment
npm run update:frontend:qa    # For qa environment
npm run update:frontend:prod  # For prod environment
```

This script uses AWS CLI commands directly to trigger a new pipeline execution and force a new ECS deployment (if the service exists). It completely bypasses the need for CDK bootstrapping and avoids issues with outdated bootstrap stacks.

### Option 3: Standard Git Workflow (Automatic Deployment)

Follow the standard Git workflow:

```bash
git checkout develop
git pull origin develop --rebase
git checkout -b feature/your-short-description
# Make your changes and test locally
git add .
git commit -m "feat: Add new feature"
git push origin HEAD
# Create a PR on GitHub
```

After your PR is reviewed and merged to the appropriate branch:

- `develop` branch for the dev environment
- `staging` branch for the staging environment
- `main` branch for the production environment

The AWS CodePipeline will automatically detect the changes and deploy the frontend application.

For versioning and changelog management (after merging):

```bash
# For semantic versioning
git tag -a v1.2.3 -m "Version 1.2.3"
git push origin v1.2.3

# For changelog generation (if using conventional-changelog)
npx conventional-changelog -p angular -i CHANGELOG.md -s -r 0
git add CHANGELOG.md
git commit -m "chore: Update changelog for v1.2.3"
git push origin develop
```

### Option 4: Manual Deployment

If you need to manually deploy the frontend:

1. Build the Docker image locally:

```bash
docker build -t bellyfed-frontend:latest .
```

2. Tag the image with your ECR repository URI:

```bash
docker tag bellyfed-frontend:latest <account-id>.dkr.ecr.<region>.amazonaws.com/bellyfed-frontend:latest
```

3. Push the image to ECR:

```bash
aws ecr get-login-password --region <region> | docker login --username AWS --password-stdin <account-id>.dkr.ecr.<region>.amazonaws.com
docker push <account-id>.dkr.ecr.<region>.amazonaws.com/bellyfed-frontend:latest
```

4. Update the ECS service:

```bash
aws ecs update-service --cluster bellyfed-<environment> --service bellyfed-frontend-service --force-new-deployment
```

## AWS Permissions

For the AWS CLI approach to work, ensure that your credentials have permissions to:

- Describe and update CodePipeline pipelines
- Describe and update ECS services
- Start pipeline executions

The IAM role or user should have these permissions:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "codepipeline:GetPipeline",
                "codepipeline:UpdatePipeline",
                "codepipeline:StartPipelineExecution",
                "ecs:DescribeClusters",
                "ecs:DescribeServices",
                "ecs:UpdateService"
            ],
            "Resource": "*"
        }
    ]
}
```

## Bypassing Bootstrap Stack Issues

If you're seeing the following error when deploying with CDK:

```
Bootstrap stack outdated
Overview: The bootstrap stack in aws://***/***/*** is outdated.
We recommend at least version 21, distributed with CDK CLI
2.149.0 or higher. Please rebootstrap your environment by
running 'cdk bootstrap aws://***/***/***'
```

You can fix bootstrap issues locally:

```bash
npm run cdk:bootstrap
```

This will create a new bootstrap stack or update an existing one using the CDK CLI.

Alternatively, you can use the trigger script which bypasses CDK completely.

## Troubleshooting

### Common Issues

1. **Access Denied Error**: If you see an "Access Denied" error page, check:

    - S3 bucket permissions
    - CloudFront distribution settings
    - Presence of index.html in the S3 bucket

2. **Missing Assets**: If the site loads but assets are missing:

    - Check the CloudFront cache policy
    - Verify the asset paths in the Next.js configuration
    - Run a CloudFront invalidation

3. **Deployment Failures**: If the deployment pipeline fails:

    - Check the CodeBuild logs for errors
    - Verify that the buildspec.yml file is correctly configured
    - Ensure the IAM roles have the necessary permissions

4. **Next.js Static Export Issues**: The Next.js application is configured with `output: 'export'` in `next.config.mjs`, which generates static files in the `out` directory. Make sure the deployment process is correctly configured to use the `out` directory.

5. **GitHub Actions Failure**: If GitHub Actions is failing with IAM role issues, follow the bootstrap stack update instructions above.

6. **Pipeline Not Triggering**: Ensure that the webhook is properly configured in GitHub. You can check this in the AWS CodePipeline console.

7. **ECS Service Not Updating**: Verify that the task definition is being updated correctly and that the ECS service has the necessary permissions.

### Getting Help

If you're still experiencing issues, please:

1. Check the CloudWatch Logs for detailed error messages
2. Review the AWS CodePipeline execution history
3. Consult the AWS CDK documentation for troubleshooting guidance

## Configuration Files

The frontend deployment is configured in the following files:

1. `lib/config.ts`: Contains the GitHub repository information and branch mapping
2. `lib/frontend-cicd-stack.ts`: Defines the CodePipeline for the frontend application
3. `bin/cdk.ts`: Creates the frontend CICD stack

## AWS Resources

The following AWS resources are created for the frontend deployment:

1. **S3 Bucket**: Stores the built frontend application
2. **CloudFront Distribution**: Serves the frontend application
3. **CodePipeline**: Orchestrates the CI/CD process
4. **CodeBuild Projects**: Build and deploy the frontend application
5. **IAM Roles**: Provide the necessary permissions for the CodeBuild projects
