# 3.1 Pages and Routes Implementation (Continued)

This document continues the implementation plan for the pages and routes required for the Rankings feature.

## Implementation Details (Continued)

### Restaurant Rankings Page

```tsx
// src/pages/restaurant/[id].tsx
import React, { useState, useEffect } from 'react';
import { NextPage, GetServerSideProps } from 'next';
import {
    Container,
    Typography,
    Box,
    Grid,
    Card,
    CardContent,
    CardActionArea,
    Chip,
    TextField,
    MenuItem,
    CircularProgress,
    Alert,
    Pagination,
} from '@mui/material';
import { getRestaurantById } from '@/lib/api/restaurantsApi';
import { getDishes } from '@/lib/api/dishesApi';
import { getUserRankings } from '@/lib/api/rankingsApi';
import { Dish } from '@/types/dish';
import { UserRanking } from '@/types/ranking';
import { useRouter } from 'next/router';

interface RestaurantRankingsPageProps {
    id: string;
}

const RestaurantRankingsPage: NextPage<RestaurantRankingsPageProps> = ({ id }) => {
    const router = useRouter();
    const [restaurant, setRestaurant] = useState<any | null>(null);
    const [dishes, setDishes] = useState<Dish[]>([]);
    const [userRankings, setUserRankings] = useState<Record<string, UserRanking>>({});
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [page, setPage] = useState(1);
    const [totalPages, setTotalPages] = useState(1);
    const [sortBy, setSortBy] = useState('name');
    const [categoryFilter, setCategoryFilter] = useState('');

    // Get unique categories for filtering
    const categories = [...new Set(dishes.map((dish) => dish.category).filter(Boolean))];

    // Fetch restaurant, dishes, and user rankings
    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            setError(null);

            try {
                // Fetch restaurant
                const restaurantResponse = await getRestaurantById(id);

                if (restaurantResponse.success) {
                    setRestaurant(restaurantResponse.data);

                    // Fetch dishes
                    const dishesResponse = await getDishes({
                        restaurant: id,
                        page,
                        pageSize: 20,
                        category: categoryFilter || undefined,
                    });

                    if (dishesResponse.success) {
                        setDishes(dishesResponse.data);

                        if (dishesResponse.meta?.pagination) {
                            setTotalPages(dishesResponse.meta.pagination.totalPages);
                        }

                        // Fetch user rankings for these dishes
                        try {
                            const userRankingsResponse = await getUserRankings({
                                restaurant: id,
                            });

                            if (userRankingsResponse.success) {
                                // Convert to a map for easier lookup
                                const rankingsMap: Record<string, UserRanking> = {};
                                userRankingsResponse.data.forEach((ranking) => {
                                    rankingsMap[ranking.dishId] = ranking;
                                });

                                setUserRankings(rankingsMap);
                            }
                        } catch (err) {
                            // User might not have rankings yet, which is fine
                            console.log('No user rankings found');
                        }
                    }
                }
            } catch (err) {
                console.error('Error fetching restaurant data:', err);
                setError('Failed to load restaurant data. Please try again.');
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [id, page, categoryFilter]);

    // Handle page change
    const handlePageChange = (event: React.ChangeEvent<unknown>, value: number) => {
        setPage(value);
    };

    // Handle sort change
    const handleSortChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        setSortBy(event.target.value);
    };

    // Handle category filter change
    const handleCategoryFilterChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        setCategoryFilter(event.target.value);
        setPage(1); // Reset to first page
    };

    // Sort dishes
    const sortedDishes = [...dishes].sort((a, b) => {
        if (sortBy === 'name') {
            return a.name.localeCompare(b.name);
        }

        if (sortBy === 'category') {
            return (a.category || '').localeCompare(b.category || '');
        }

        if (sortBy === 'price') {
            const priceA = a.price || 0;
            const priceB = b.price || 0;
            return priceA - priceB;
        }

        if (sortBy === 'rank') {
            const rankA = userRankings[a.id]?.rank || 999;
            const rankB = userRankings[b.id]?.rank || 999;
            return rankA - rankB;
        }

        return 0;
    });

    // Handle dish click
    const handleDishClick = (slug: string) => {
        router.push(`/dish/${slug}`);
    };

    if (loading) {
        return (
            <Container maxWidth="lg" sx={{ py: 4 }}>
                <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                    <CircularProgress />
                </Box>
            </Container>
        );
    }

    if (error || !restaurant) {
        return (
            <Container maxWidth="lg" sx={{ py: 4 }}>
                <Alert severity="error" sx={{ mb: 3 }}>
                    {error || 'Restaurant not found'}
                </Alert>
                <Button onClick={() => router.back()}>Go Back</Button>
            </Container>
        );
    }

    return (
        <Container maxWidth="lg" sx={{ py: 4 }}>
            <Typography variant="h4" component="h1" gutterBottom>
                {restaurant.name}
            </Typography>

            {restaurant.address && (
                <Typography variant="body1" color="text.secondary" gutterBottom>
                    {restaurant.address}
                </Typography>
            )}

            <Box sx={{ mb: 4 }}>
                <Typography variant="h6" gutterBottom>
                    Dishes
                </Typography>

                <Grid container spacing={2} sx={{ mb: 3 }}>
                    <Grid item xs={12} sm={6} md={4}>
                        <TextField
                            select
                            label="Category"
                            value={categoryFilter}
                            onChange={handleCategoryFilterChange}
                            fullWidth
                            size="small"
                        >
                            <MenuItem value="">All Categories</MenuItem>
                            {categories.map((category) => (
                                <MenuItem key={category} value={category}>
                                    {category}
                                </MenuItem>
                            ))}
                        </TextField>
                    </Grid>

                    <Grid item xs={12} sm={6} md={4}>
                        <TextField
                            select
                            label="Sort By"
                            value={sortBy}
                            onChange={handleSortChange}
                            fullWidth
                            size="small"
                        >
                            <MenuItem value="name">Name</MenuItem>
                            <MenuItem value="category">Category</MenuItem>
                            <MenuItem value="price">Price</MenuItem>
                            <MenuItem value="rank">Your Ranking</MenuItem>
                        </TextField>
                    </Grid>
                </Grid>

                {sortedDishes.length === 0 ? (
                    <Alert severity="info">No dishes found for this restaurant.</Alert>
                ) : (
                    <Grid container spacing={2}>
                        {sortedDishes.map((dish) => {
                            const userRanking = userRankings[dish.id];

                            return (
                                <Grid item xs={12} sm={6} md={4} key={dish.id}>
                                    <Card variant="outlined">
                                        <CardActionArea onClick={() => handleDishClick(dish.slug)}>
                                            <CardContent>
                                                <Typography variant="h6" gutterBottom>
                                                    {dish.name}
                                                </Typography>

                                                {dish.category && (
                                                    <Typography
                                                        variant="body2"
                                                        color="text.secondary"
                                                        gutterBottom
                                                    >
                                                        {dish.category}
                                                    </Typography>
                                                )}

                                                <Box
                                                    sx={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        mt: 1,
                                                    }}
                                                >
                                                    {dish.price && (
                                                        <Typography variant="body2" sx={{ mr: 2 }}>
                                                            ${dish.price.toFixed(2)}
                                                        </Typography>
                                                    )}

                                                    {userRanking && (
                                                        <Chip
                                                            size="small"
                                                            label={
                                                                userRanking.rank !== undefined
                                                                    ? `Rank: ${userRanking.rank}`
                                                                    : userRanking.tasteStatus?.replace(
                                                                          '_',
                                                                          ' '
                                                                      )
                                                            }
                                                            color={
                                                                userRanking.rank !== undefined
                                                                    ? userRanking.rank <= 2
                                                                        ? 'success'
                                                                        : userRanking.rank === 3
                                                                          ? 'warning'
                                                                          : 'error'
                                                                    : userRanking.tasteStatus ===
                                                                        'ACCEPTABLE'
                                                                      ? 'success'
                                                                      : userRanking.tasteStatus ===
                                                                          'SECOND_CHANCE'
                                                                        ? 'warning'
                                                                        : 'error'
                                                            }
                                                        />
                                                    )}
                                                </Box>
                                            </CardContent>
                                        </CardActionArea>
                                    </Card>
                                </Grid>
                            );
                        })}
                    </Grid>
                )}

                {totalPages > 1 && (
                    <Box sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>
                        <Pagination
                            count={totalPages}
                            page={page}
                            onChange={handlePageChange}
                            color="primary"
                        />
                    </Box>
                )}
            </Box>
        </Container>
    );
};

export const getServerSideProps: GetServerSideProps = async (context) => {
    const { id } = context.params as { id: string };

    return {
        props: {
            id,
        },
    };
};

export default RestaurantRankingsPage;
```

### Navigation Integration

To integrate the rankings feature into the main navigation, we need to update the navigation component:

```tsx
// src/components/layout/Navigation.tsx
import React from 'react';
import {
    AppBar,
    Toolbar,
    Typography,
    Button,
    Box,
    IconButton,
    Menu,
    MenuItem,
} from '@mui/material';
import { AccountCircle, Restaurant, Star } from '@mui/icons-material';
import Link from 'next/link';
import { useRouter } from 'next/router';
import { useAuth } from '@/context/AuthContext';

export const Navigation: React.FC = () => {
    const router = useRouter();
    const { user, logout } = useAuth();
    const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);

    const handleMenu = (event: React.MouseEvent<HTMLElement>) => {
        setAnchorEl(event.currentTarget);
    };

    const handleClose = () => {
        setAnchorEl(null);
    };

    const handleLogout = () => {
        logout();
        handleClose();
        router.push('/login');
    };

    return (
        <AppBar position="static">
            <Toolbar>
                <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
                    <Link href="/" passHref>
                        <Box component="a" sx={{ color: 'inherit', textDecoration: 'none' }}>
                            Bellyfed
                        </Box>
                    </Link>
                </Typography>

                <Box sx={{ display: 'flex', alignItems: 'center' }}>
                    <Link href="/restaurants" passHref>
                        <Button color="inherit" startIcon={<Restaurant />} sx={{ mr: 1 }}>
                            Restaurants
                        </Button>
                    </Link>

                    {/* Add My Rankings button */}
                    {user && (
                        <Link href="/my-rankings" passHref>
                            <Button color="inherit" startIcon={<Star />} sx={{ mr: 1 }}>
                                My Rankings
                            </Button>
                        </Link>
                    )}

                    {user ? (
                        <>
                            <IconButton
                                size="large"
                                aria-label="account of current user"
                                aria-controls="menu-appbar"
                                aria-haspopup="true"
                                onClick={handleMenu}
                                color="inherit"
                            >
                                <AccountCircle />
                            </IconButton>
                            <Menu
                                id="menu-appbar"
                                anchorEl={anchorEl}
                                anchorOrigin={{
                                    vertical: 'bottom',
                                    horizontal: 'right',
                                }}
                                keepMounted
                                transformOrigin={{
                                    vertical: 'top',
                                    horizontal: 'right',
                                }}
                                open={Boolean(anchorEl)}
                                onClose={handleClose}
                            >
                                <MenuItem
                                    onClick={() => {
                                        handleClose();
                                        router.push('/profile');
                                    }}
                                >
                                    Profile
                                </MenuItem>
                                <MenuItem
                                    onClick={() => {
                                        handleClose();
                                        router.push('/my-rankings');
                                    }}
                                >
                                    My Rankings
                                </MenuItem>
                                <MenuItem onClick={handleLogout}>Logout</MenuItem>
                            </Menu>
                        </>
                    ) : (
                        <>
                            <Link href="/login" passHref>
                                <Button color="inherit" sx={{ mr: 1 }}>
                                    Login
                                </Button>
                            </Link>
                            <Link href="/register" passHref>
                                <Button color="inherit" variant="outlined">
                                    Register
                                </Button>
                            </Link>
                        </>
                    )}
                </Box>
            </Toolbar>
        </AppBar>
    );
};
```

## Testing

- [ ] Write unit tests for Restaurant Rankings page

    - Test filtering and sorting
    - Test pagination
    - Test dish card rendering

- [ ] Write integration tests for navigation
    - Test navigation to rankings pages
    - Test authenticated vs. unauthenticated views

## Dependencies

- Next.js for page routing
- Material UI for UI components
- API clients from previous step
- Core components from previous step

## Estimated Time

- Restaurant Rankings Page: 1.5 days
- Navigation Integration: 0.5 day
- Testing: 1 day

Total: 3 days
